<!-- Bulk Actions Enabled - v2.0 - Last Updated: 2025-11-13 -->
{% extends "base.html" %}

{% block title %}Pending Bookings - Admin - Campus Resource Hub{% endblock %}

{% block extra_css %}
<style>
    .admin-container {
        max-width: 1200px;
        margin: 0 auto;
        padding: var(--space-xl) var(--space-md);
    }

    .page-header {
        margin-bottom: var(--space-2xl);
    }

    .page-header h1 {
        color: var(--iu-dark);
        font-size: var(--font-size-3xl);
        margin-bottom: var(--space-sm);
    }

    .page-header p {
        color: var(--neutral-gray-600);
        font-size: var(--font-size-md);
    }

    .bookings-table {
        width: 100%;
        border-collapse: collapse;
        background: var(--neutral-white);
        border-radius: var(--radius-lg);
        overflow: hidden;
        box-shadow: var(--shadow-md);
    }

    .bookings-table thead {
        background: linear-gradient(135deg, var(--iu-dark), #333);
        color: white;
    }

    .bookings-table th {
        padding: var(--space-md) var(--space-lg);
        text-align: left;
        font-weight: 600;
        text-transform: uppercase;
        font-size: var(--font-size-xs);
        letter-spacing: 0.5px;
    }

    .bookings-table td {
        padding: var(--space-md) var(--space-lg);
        border-bottom: 1px solid var(--neutral-gray-200);
    }

    .bookings-table tbody tr:hover {
        background: var(--neutral-gray-50);
    }

    .booking-resource {
        font-weight: 600;
        color: var(--iu-crimson);
    }

    .booking-user {
        color: var(--iu-dark);
    }

    .booking-time {
        color: var(--neutral-gray-600);
        font-size: var(--font-size-sm);
    }

    .action-buttons {
        display: flex;
        gap: var(--space-sm);
    }

    .btn-approve {
        background: #10B981;
        color: white;
        padding: var(--space-xs) var(--space-md);
        border: none;
        border-radius: var(--radius-lg);
        cursor: pointer;
        font-weight: 600;
        font-size: var(--font-size-sm);
        transition: all var(--transition-fast);
    }

    .btn-approve:hover {
        background: #059669;
        box-shadow: var(--shadow-lg);
    }

    .btn-reject {
        background: #EF4444;
        color: white;
        padding: var(--space-xs) var(--space-md);
        border: none;
        border-radius: var(--radius-lg);
        cursor: pointer;
        font-weight: 600;
        font-size: var(--font-size-sm);
        transition: all var(--transition-fast);
    }

    .btn-reject:hover {
        background: #DC2626;
        box-shadow: var(--shadow-lg);
    }

    .empty-state {
        text-align: center;
        padding: var(--space-3xl);
        background: var(--neutral-white);
        border-radius: var(--radius-lg);
        box-shadow: var(--shadow-md);
    }

    .empty-state-icon {
        font-size: 64px;
        margin-bottom: var(--space-lg);
    }

    .empty-state h2 {
        color: var(--iu-dark);
        font-size: var(--font-size-2xl);
        margin-bottom: var(--space-md);
    }

    .empty-state p {
        color: var(--neutral-gray-600);
        font-size: var(--font-size-md);
    }

    /* Bulk Actions */
    .bulk-actions-bar {
        background: var(--neutral-white);
        border-radius: var(--radius-lg);
        padding: var(--space-lg);
        margin-bottom: var(--space-lg);
        box-shadow: var(--shadow-md);
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: var(--space-md);
    }

    .bulk-selection-info {
        display: flex;
        align-items: center;
        gap: var(--space-md);
        color: var(--neutral-gray-700);
        font-size: var(--font-size-md);
    }

    .selected-count {
        background: var(--iu-crimson);
        color: white;
        padding: var(--space-xs) var(--space-md);
        border-radius: var(--radius-full);
        font-weight: 700;
        font-size: var(--font-size-sm);
    }

    .bulk-action-buttons {
        display: flex;
        gap: var(--space-md);
    }

    .btn-bulk-approve {
        background: #10B981;
        color: white;
        padding: var(--space-md) var(--space-xl);
        border: none;
        border-radius: var(--radius-lg);
        cursor: pointer;
        font-weight: 600;
        font-size: var(--font-size-md);
        transition: all var(--transition-fast);
        display: flex;
        align-items: center;
        gap: var(--space-sm);
    }

    .btn-bulk-approve:hover:not(:disabled) {
        background: #059669;
        box-shadow: var(--shadow-lg);
        transform: translateY(-2px);
    }

    .btn-bulk-approve:disabled {
        opacity: 0.5;
        cursor: not-allowed;
    }

    .btn-bulk-reject {
        background: #EF4444;
        color: white;
        padding: var(--space-md) var(--space-xl);
        border: none;
        border-radius: var(--radius-lg);
        cursor: pointer;
        font-weight: 600;
        font-size: var(--font-size-md);
        transition: all var(--transition-fast);
        display: flex;
        align-items: center;
        gap: var(--space-sm);
    }

    .btn-bulk-reject:hover:not(:disabled) {
        background: #DC2626;
        box-shadow: var(--shadow-lg);
        transform: translateY(-2px);
    }

    .btn-bulk-reject:disabled {
        opacity: 0.5;
        cursor: not-allowed;
    }

    .btn-clear-selection {
        background: transparent;
        color: var(--neutral-gray-600);
        padding: var(--space-md) var(--space-lg);
        border: 1px solid var(--neutral-gray-300);
        border-radius: var(--radius-lg);
        cursor: pointer;
        font-weight: 600;
        font-size: var(--font-size-sm);
        transition: all var(--transition-fast);
    }

    .btn-clear-selection:hover {
        border-color: var(--neutral-gray-400);
        background: var(--neutral-gray-50);
    }

    /* Checkbox styling */
    .booking-checkbox {
        width: 20px;
        height: 20px;
        cursor: pointer;
        accent-color: var(--iu-crimson);
    }

    .select-all-checkbox {
        width: 20px;
        height: 20px;
        cursor: pointer;
        accent-color: var(--iu-crimson);
    }

    /* Row selection highlight */
    .bookings-table tbody tr.selected {
        background: #FEF2F2 !important;
        border-left: 4px solid var(--iu-crimson);
    }

    .btn-view-details {
        background: var(--iu-crimson);
        color: white;
        padding: var(--space-xs) var(--space-md);
        border: none;
        border-radius: var(--radius-lg);
        cursor: pointer;
        font-weight: 600;
        font-size: var(--font-size-sm);
        transition: all var(--transition-fast);
    }

    .btn-view-details:hover {
        background: var(--iu-dark);
        box-shadow: var(--shadow-lg);
    }

    @media (max-width: 768px) {
        .admin-container {
            padding: var(--space-lg) var(--space-md);
        }

        .bookings-table {
            font-size: var(--font-size-sm);
        }

        .bookings-table th,
        .bookings-table td {
            padding: var(--space-sm) var(--space-md);
        }

        .action-buttons {
            flex-direction: column;
        }

        .btn-approve,
        .btn-reject {
            width: 100%;
        }

        .bulk-actions-bar {
            flex-direction: column;
            align-items: stretch;
        }

        .bulk-action-buttons {
            flex-direction: column;
        }

        .btn-bulk-approve,
        .btn-bulk-reject {
            width: 100%;
            justify-content: center;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="admin-container">
    <!-- Page Header -->
    <div class="page-header">
        <h1>‚è≥ Pending Booking Approvals</h1>
        <p>Review and approve bookings for resources that require manual approval</p>
    </div>

    {% if bookings %}
        <!-- Bulk Actions Bar -->
        <div class="bulk-actions-bar" id="bulkActionsBar">
            <div class="bulk-selection-info">
                <span class="selected-count" id="selectedCount">0</span>
                <span>booking(s) selected</span>
            </div>
            <div class="bulk-action-buttons">
                <button class="btn-bulk-approve" id="btnBulkApprove" onclick="bulkApproveBookings()" disabled>
                    ‚úì Approve Selected
                </button>
                <button class="btn-bulk-reject" id="btnBulkReject" onclick="bulkRejectBookings()" disabled>
                    ‚úï Reject Selected
                </button>
                <button class="btn-clear-selection" onclick="clearSelection()">
                    Clear Selection
                </button>
            </div>
        </div>

        <table class="bookings-table">
            <thead>
                <tr>
                    <th style="width: 40px;">
                        <input type="checkbox" class="select-all-checkbox" id="selectAll" onchange="toggleSelectAll(this)">
                    </th>
                    <th>Resource</th>
                    <th>User</th>
                    <th>Start Time</th>
                    <th>End Time</th>
                    <th>Requested</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                {% for booking in bookings %}
                <tr id="booking-row-{{ booking.id }}" data-booking-id="{{ booking.id }}">
                    <td>
                        <input type="checkbox" class="booking-checkbox" data-booking-id="{{ booking.id }}" onchange="updateSelection()">
                    </td>
                    <td>
                        <div class="booking-resource">{{ booking.resource.name }}</div>
                        <div class="booking-time">{{ booking.resource.resource_type }}</div>
                    </td>
                    <td class="booking-user">
                        <strong>{{ booking.user.full_name or booking.user.username }}</strong><br>
                        <span style="color: var(--neutral-gray-600); font-size: var(--font-size-sm);">{{ booking.user.email }}</span>
                    </td>
                    <td class="booking-time">
                        {{ booking.start_time.strftime('%b %d, %Y %I:%M %p') }}
                    </td>
                    <td class="booking-time">
                        {{ booking.end_time.strftime('%I:%M %p') }}
                    </td>
                    <td class="booking-time">
                        {{ booking.created_at.strftime('%b %d, %Y') }}
                    </td>
                    <td>
                        <div class="action-buttons">
                            <button class="btn-view-details" onclick="window.location.href='/bookings/{{ booking.id }}'">
                                üëÅÔ∏è Details
                            </button>
                            <button class="btn-approve" onclick="approveBooking({{ booking.id }})">
                                ‚úì Approve
                            </button>
                            <button class="btn-reject" onclick="rejectBooking({{ booking.id }})">
                                ‚úï Reject
                            </button>
                        </div>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    {% else %}
        <div class="empty-state">
            <div class="empty-state-icon">‚úì</div>
            <h2>All Caught Up!</h2>
            <p>No pending bookings to review. All booking approvals are current.</p>
        </div>
    {% endif %}
</div>

<script>
// Global CSRF Token - loaded at page initialization
const CSRF_TOKEN = '{{ csrf_token() }}';
console.log('[GLOBAL] CSRF Token loaded on admin/pending_bookings:', CSRF_TOKEN ? `‚úÖ Present (${CSRF_TOKEN.length} chars)` : '‚ùå Missing');

// Track selected bookings
let selectedBookings = new Set();

function updateSelection() {
    const checkboxes = document.querySelectorAll('.booking-checkbox');
    selectedBookings.clear();
    
    checkboxes.forEach(cb => {
        const row = document.getElementById(`booking-row-${cb.dataset.bookingId}`);
        if (cb.checked) {
            selectedBookings.add(parseInt(cb.dataset.bookingId));
            row.classList.add('selected');
        } else {
            row.classList.remove('selected');
        }
    });
    
    // Update UI
    const count = selectedBookings.size;
    document.getElementById('selectedCount').textContent = count;
    document.getElementById('btnBulkApprove').disabled = count === 0;
    document.getElementById('btnBulkReject').disabled = count === 0;
    
    // Update select all checkbox
    const selectAllCb = document.getElementById('selectAll');
    selectAllCb.checked = count > 0 && count === checkboxes.length;
    selectAllCb.indeterminate = count > 0 && count < checkboxes.length;
}

function toggleSelectAll(checkbox) {
    const checkboxes = document.querySelectorAll('.booking-checkbox');
    checkboxes.forEach(cb => {
        cb.checked = checkbox.checked;
    });
    updateSelection();
}

function clearSelection() {
    const checkboxes = document.querySelectorAll('.booking-checkbox');
    checkboxes.forEach(cb => {
        cb.checked = false;
    });
    document.getElementById('selectAll').checked = false;
    updateSelection();
}

function approveBooking(bookingId) {
    if (confirm('Approve this booking?')) {
        fetch(`/bookings/${bookingId}/confirm`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': CSRF_TOKEN
            },
            body: JSON.stringify({
                csrf_token: CSRF_TOKEN
            })
        })
        .then(response => {
            if (!response.ok) {
                return response.text().then(text => {
                    throw new Error(`HTTP ${response.status}: ${text}`);
                });
            }
            return response.json();
        })
        .then(data => {
            if (data.success) {
                // Remove row with animation
                const row = document.getElementById(`booking-row-${bookingId}`);
                row.style.opacity = '0';
                row.style.transition = 'opacity 0.3s ease';
                setTimeout(() => {
                    row.remove();
                    updateSelection();
                    if (document.querySelectorAll('.booking-checkbox').length === 0) {
                        location.reload();
                    }
                }, 300);
            } else {
                alert('Error: ' + (data.error || data.message));
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Error approving booking: ' + error.message);
        });
    }
}

function rejectBooking(bookingId) {
    if (confirm('Reject this booking?')) {
        fetch(`/bookings/${bookingId}`, {
            method: 'DELETE',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': CSRF_TOKEN
            }
        })
        .then(response => {
            if (!response.ok) {
                return response.text().then(text => {
                    throw new Error(`HTTP ${response.status}: ${text}`);
                });
            }
            return response.json();
        })
        .then(data => {
            if (data.success) {
                // Remove row with animation
                const row = document.getElementById(`booking-row-${bookingId}`);
                row.style.opacity = '0';
                row.style.transition = 'opacity 0.3s ease';
                setTimeout(() => {
                    row.remove();
                    updateSelection();
                    if (document.querySelectorAll('.booking-checkbox').length === 0) {
                        location.reload();
                    }
                }, 300);
            } else {
                alert('Error: ' + (data.error || data.message));
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Error rejecting booking: ' + error.message);
        });
    }
}

async function bulkApproveBookings() {
    const count = selectedBookings.size;
    if (count === 0) return;
    
    if (!confirm(`Approve ${count} selected booking(s)?`)) return;
    
    const bookingIds = Array.from(selectedBookings);
    let successful = 0;
    let failed = 0;
    
    // Show progress
    const btnApprove = document.getElementById('btnBulkApprove');
    const originalText = btnApprove.innerHTML;
    btnApprove.disabled = true;
    btnApprove.innerHTML = '‚è≥ Processing...';
    
    for (const bookingId of bookingIds) {
        try {
            const response = await fetch(`/bookings/${bookingId}/confirm`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': CSRF_TOKEN
                },
                body: JSON.stringify({
                    csrf_token: CSRF_TOKEN
                })
            });
            
            const data = await response.json();
            if (data.success) {
                successful++;
                const row = document.getElementById(`booking-row-${bookingId}`);
                row.style.opacity = '0';
                row.style.transition = 'opacity 0.3s ease';
                setTimeout(() => row.remove(), 300);
            } else {
                failed++;
            }
        } catch (error) {
            console.error(`Error approving booking ${bookingId}:`, error);
            failed++;
        }
    }
    
    // Show results
    clearSelection();
    btnApprove.innerHTML = originalText;
    
    const message = `‚úÖ Approved: ${successful}` + (failed > 0 ? `\n‚ùå Failed: ${failed}` : '');
    alert(message);
    
    if (document.querySelectorAll('.booking-checkbox').length === 0) {
        location.reload();
    }
}

async function bulkRejectBookings() {
    const count = selectedBookings.size;
    if (count === 0) return;
    
    if (!confirm(`Reject ${count} selected booking(s)? This action cannot be undone.`)) return;
    
    const bookingIds = Array.from(selectedBookings);
    let successful = 0;
    let failed = 0;
    
    // Show progress
    const btnReject = document.getElementById('btnBulkReject');
    const originalText = btnReject.innerHTML;
    btnReject.disabled = true;
    btnReject.innerHTML = '‚è≥ Processing...';
    
    for (const bookingId of bookingIds) {
        try {
            const response = await fetch(`/bookings/${bookingId}`, {
                method: 'DELETE',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': CSRF_TOKEN
                }
            });
            
            const data = await response.json();
            if (data.success) {
                successful++;
                const row = document.getElementById(`booking-row-${bookingId}`);
                row.style.opacity = '0';
                row.style.transition = 'opacity 0.3s ease';
                setTimeout(() => row.remove(), 300);
            } else {
                failed++;
            }
        } catch (error) {
            console.error(`Error rejecting booking ${bookingId}:`, error);
            failed++;
        }
    }
    
    // Show results
    clearSelection();
    btnReject.innerHTML = originalText;
    
    const message = `‚úÖ Rejected: ${successful}` + (failed > 0 ? `\n‚ùå Failed: ${failed}` : '');
    alert(message);
    
    if (document.querySelectorAll('.booking-checkbox').length === 0) {
        location.reload();
    }
}

// Initialize on page load
document.addEventListener('DOMContentLoaded', function() {
    updateSelection();
});
</script>
{% endblock %}
