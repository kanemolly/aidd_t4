{% extends "base.html" %}

{% block title %}{{ 'All Bookings' if is_admin_view else 'My Bookings' }} - Campus Resource Hub{% endblock %}

{% block extra_css %}
<style>
    .bookings-container {
        max-width: 1400px;
        margin: 0 auto;
        padding: var(--space-xl) var(--space-md);
    }

    .page-header {
        margin-bottom: var(--space-2xl);
    }

    .page-header h1 {
        color: var(--iu-dark);
        font-size: var(--font-size-3xl);
        margin-bottom: var(--space-sm);
        display: flex;
        align-items: center;
        gap: var(--space-md);
    }

    .admin-badge {
        background: linear-gradient(135deg, var(--iu-crimson), #4B0000);
        color: white;
        padding: var(--space-xs) var(--space-md);
        border-radius: var(--radius-full);
        font-size: var(--font-size-sm);
        font-weight: 600;
    }

    .page-header p {
        color: var(--neutral-gray-600);
        font-size: var(--font-size-md);
    }

    /* Status Filter */
    .filter-section {
        background: var(--neutral-white);
        padding: var(--space-lg);
        border-radius: var(--radius-xl);
        box-shadow: var(--shadow-md);
        margin-bottom: var(--space-xl);
        border: 1px solid var(--neutral-gray-200);
    }

    .filter-buttons {
        display: flex;
        gap: var(--space-sm);
        flex-wrap: wrap;
    }

    .filter-btn {
        padding: var(--space-sm) var(--space-lg);
        border: 2px solid var(--neutral-gray-300);
        background: var(--neutral-white);
        color: var(--iu-dark);
        border-radius: var(--radius-lg);
        cursor: pointer;
        transition: all var(--transition-fast);
        font-weight: 500;
        font-size: var(--font-size-sm);
    }

    .filter-btn:hover {
        border-color: var(--iu-crimson);
        color: var(--iu-crimson);
    }

    .filter-btn.active {
        background: var(--iu-crimson);
        color: white;
        border-color: var(--iu-crimson);
    }

    /* Bookings Grid */
    .bookings-grid {
        display: grid;
        gap: var(--space-lg);
        grid-template-columns: repeat(auto-fit, minmax(500px, 1fr));
    }

    .booking-card {
        background: var(--neutral-white);
        border-radius: var(--radius-xl);
        padding: var(--space-lg);
        box-shadow: var(--shadow-md);
        border: 1px solid var(--neutral-gray-200);
        transition: all var(--transition-base);
        display: flex;
        flex-direction: column;
    }

    .booking-card:hover {
        box-shadow: var(--shadow-xl);
        transform: translateY(-2px);
    }

    .booking-header {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        margin-bottom: var(--space-md);
        gap: var(--space-md);
    }

    .booking-title {
        flex: 1;
        min-width: 0;
    }

    .booking-title h3 {
        color: var(--iu-dark);
        font-size: var(--font-size-lg);
        margin: 0 0 var(--space-xs) 0;
        word-break: break-word;
    }

    .booking-title a {
        color: var(--iu-crimson);
        text-decoration: none;
        font-weight: 600;
    }

    .booking-title a:hover {
        text-decoration: underline;
    }

    .resource-type {
        color: var(--neutral-gray-600);
        font-size: var(--font-size-sm);
        text-transform: capitalize;
    }

    .status-badge {
        padding: var(--space-xs) var(--space-md);
        border-radius: var(--radius-full);
        font-size: var(--font-size-xs);
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        white-space: nowrap;
    }

    .status-pending {
        background: #FEF3C7;
        color: #92400E;
    }

    .status-confirmed {
        background: #D1FAE5;
        color: #065F46;
    }

    .status-cancelled {
        background: #FEE2E2;
        color: #991B1B;
    }

    .status-completed {
        background: #E0E7FF;
        color: #3730A3;
    }

    .booking-details {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: var(--space-md);
        margin-bottom: var(--space-md);
        flex-grow: 1;
    }

    .detail-item {
        display: flex;
        flex-direction: column;
        gap: var(--space-xs);
    }

    .detail-label {
        color: var(--neutral-gray-600);
        font-size: var(--font-size-xs);
        text-transform: uppercase;
        letter-spacing: 0.5px;
        font-weight: 600;
    }

    .detail-value {
        color: var(--iu-dark);
        font-size: var(--font-size-md);
        font-weight: 500;
    }

    .booking-user {
        color: var(--iu-crimson);
        font-weight: 600;
    }

    .booking-actions {
        display: flex;
        gap: var(--space-sm);
        padding-top: var(--space-md);
        border-top: 1px solid var(--neutral-gray-200);
        flex-wrap: wrap;
    }

    .btn {
        padding: var(--space-sm) var(--space-lg);
        border-radius: var(--radius-lg);
        font-weight: 600;
        font-size: var(--font-size-sm);
        cursor: pointer;
        transition: all var(--transition-fast);
        border: none;
        text-decoration: none;
        display: inline-flex;
        align-items: center;
        gap: var(--space-xs);
    }

    .btn-primary {
        background: var(--iu-crimson);
        color: white;
    }

    .btn-primary:hover {
        background: #4B0000;
        color: white;
        transform: translateY(-2px);
        box-shadow: var(--shadow-lg);
    }

    .btn-secondary {
        background: var(--neutral-gray-200);
        color: var(--iu-dark);
    }

    .btn-secondary:hover {
        background: var(--neutral-gray-300);
        color: var(--iu-dark);
    }

    .btn-danger {
        background: #FEE2E2;
        color: #991B1B;
        border: 2px solid #991B1B;
    }

    .btn-danger:hover {
        background: #991B1B;
        color: white;
    }

    .empty-state {
        text-align: center;
        padding: var(--space-3xl);
        background: var(--neutral-white);
        border-radius: var(--radius-xl);
        box-shadow: var(--shadow-md);
    }

    .empty-state-icon {
        font-size: 64px;
        margin-bottom: var(--space-lg);
    }

    .empty-state h2 {
        color: var(--iu-dark);
        font-size: var(--font-size-2xl);
        margin-bottom: var(--space-md);
    }

    .empty-state p {
        color: var(--neutral-gray-600);
        font-size: var(--font-size-md);
        margin-bottom: var(--space-xl);
    }

    @media (max-width: 1024px) {
        .bookings-grid {
            grid-template-columns: 1fr;
        }
    }

    @media (max-width: 768px) {
        .bookings-container {
            padding: var(--space-lg) var(--space-md);
        }

        .booking-header {
            flex-direction: column;
        }

        .booking-details {
            grid-template-columns: 1fr;
        }

        .booking-card {
            padding: var(--space-md);
        }

        .filter-buttons {
            flex-direction: column;
        }

        .filter-btn {
            width: 100%;
        }
    }

    /* Cancel Modal Styles */
    .cancel-modal {
        display: none;
        position: fixed;
        z-index: 1000;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.6);
        backdrop-filter: blur(4px);
        align-items: center;
        justify-content: center;
        animation: fadeIn 0.2s ease;
    }

    @keyframes fadeIn {
        from { opacity: 0; }
        to { opacity: 1; }
    }

    .cancel-modal-content {
        background: var(--neutral-white);
        border-radius: var(--radius-xl);
        box-shadow: var(--shadow-2xl);
        max-width: 500px;
        width: 90%;
        animation: slideUp 0.3s ease;
    }

    @keyframes slideUp {
        from {
            transform: translateY(50px);
            opacity: 0;
        }
        to {
            transform: translateY(0);
            opacity: 1;
        }
    }

    .cancel-modal-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: var(--space-xl);
        border-bottom: 1px solid var(--neutral-gray-200);
    }

    .cancel-modal-header h2 {
        color: var(--iu-dark);
        font-size: var(--font-size-xl);
        margin: 0;
    }

    .cancel-modal-close {
        background: none;
        border: none;
        font-size: 32px;
        color: var(--neutral-gray-500);
        cursor: pointer;
        transition: color var(--transition-fast);
        line-height: 1;
        padding: 0;
        width: 32px;
        height: 32px;
    }

    .cancel-modal-close:hover {
        color: var(--iu-crimson);
    }

    .cancel-modal-body {
        padding: var(--space-xl);
        text-align: center;
    }

    .cancel-icon {
        font-size: 64px;
        margin-bottom: var(--space-md);
    }

    .cancel-modal-body p {
        color: var(--neutral-gray-700);
        font-size: var(--font-size-md);
        margin-bottom: var(--space-md);
        line-height: 1.6;
    }

    .cancel-modal-body strong {
        color: var(--iu-crimson);
        font-weight: 600;
    }

    .cancel-warning {
        color: var(--neutral-gray-500);
        font-size: var(--font-size-sm) !important;
        font-style: italic;
    }

    .cancel-modal-footer {
        display: flex;
        gap: var(--space-md);
        padding: var(--space-xl);
        border-top: 1px solid var(--neutral-gray-200);
    }

    .cancel-modal-footer .btn {
        flex: 1;
        padding: var(--space-md) var(--space-xl);
        border-radius: var(--radius-lg);
        font-weight: 600;
        cursor: pointer;
        transition: all var(--transition-fast);
        border: none;
        font-size: var(--font-size-md);
    }

    .btn-secondary {
        background: var(--neutral-gray-200);
        color: var(--iu-dark);
    }

    .btn-secondary:hover {
        background: var(--neutral-gray-300);
        color: var(--iu-dark);
    }

    .btn-danger {
        background: var(--iu-crimson);
        color: white;
    }

    .btn-danger:hover {
        background: #7A0000;
        color: white;
        transform: translateY(-1px);
        box-shadow: var(--shadow-md);
    }

    /* Success Alert */
    .alert-success {
        position: fixed;
        top: 20px;
        right: 20px;
        background: linear-gradient(135deg, #10b981, #059669);
        color: white;
        padding: var(--space-lg) var(--space-xl);
        border-radius: var(--radius-lg);
        box-shadow: var(--shadow-xl);
        z-index: 1001;
        font-weight: 600;
        animation: slideInRight 0.3s ease;
    }

    @keyframes slideInRight {
        from {
            transform: translateX(400px);
            opacity: 0;
        }
        to {
            transform: translateX(0);
            opacity: 1;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="bookings-container">
    <div class="page-header">
        <h1>
            {% if is_admin_view %}
                üìÖ All Bookings <span class="admin-badge">Admin View</span>
            {% else %}
                üìÖ My Bookings
            {% endif %}
        </h1>
        <p>
            {% if is_admin_view %}
                View and manage all resource bookings across the system
            {% else %}
                View and manage your resource reservations
            {% endif %}
        </p>
    </div>

    <!-- Status Filter -->
    <div class="filter-section">
        <div class="filter-buttons">
            <a href="{{ url_for('bookings.list_bookings') }}" 
               class="filter-btn {{ 'active' if not current_status else '' }}">
                All Bookings
            </a>
            <a href="{{ url_for('bookings.list_bookings', status='pending') }}" 
               class="filter-btn {{ 'active' if current_status == 'pending' else '' }}">
                Pending
            </a>
            <a href="{{ url_for('bookings.list_bookings', status='confirmed') }}" 
               class="filter-btn {{ 'active' if current_status == 'confirmed' else '' }}">
                Confirmed
            </a>
            <a href="{{ url_for('bookings.list_bookings', status='completed') }}" 
               class="filter-btn {{ 'active' if current_status == 'completed' else '' }}">
                Completed
            </a>
            <a href="{{ url_for('bookings.list_bookings', status='cancelled') }}" 
               class="filter-btn {{ 'active' if current_status == 'cancelled' else '' }}">
                Cancelled
            </a>
        </div>
    </div>

    <!-- Bookings List -->
    {% if bookings %}
        <div class="bookings-grid">
            {% for booking in bookings %}
            <div class="booking-card">
                <div class="booking-header">
                    <div class="booking-title">
                        <h3>
                            <a href="{{ url_for('resources.detail_resource', resource_id=booking.resource_id) }}">
                                {{ booking.resource.name }}
                            </a>
                        </h3>
                        <span class="resource-type">{{ booking.resource.resource_type }}</span>
                    </div>
                    <span class="status-badge status-{{ booking.status }}">
                        {{ booking.status }}
                    </span>
                </div>

                <div class="booking-details">
                    {% if is_admin_view %}
                    <div class="detail-item">
                        <span class="detail-label">Booked By</span>
                        <span class="detail-value booking-user">
                            {{ booking.user.full_name }}
                        </span>
                    </div>
                    {% endif %}

                    <div class="detail-item">
                        <span class="detail-label">Start Time</span>
                        <span class="detail-value">
                            {{ booking.start_time.strftime('%b %d, %Y at %I:%M %p') }}
                        </span>
                    </div>

                    <div class="detail-item">
                        <span class="detail-label">End Time</span>
                        <span class="detail-value">
                            {{ booking.end_time.strftime('%b %d, %Y at %I:%M %p') }}
                        </span>
                    </div>

                    <div class="detail-item">
                        <span class="detail-label">Duration</span>
                        <span class="detail-value">
                            {% set duration = (booking.end_time - booking.start_time).total_seconds() / 3600 %}
                            {{ "%.1f"|format(duration) }} hours
                        </span>
                    </div>

                    {% if booking.resource.location %}
                    <div class="detail-item">
                        <span class="detail-label">Location</span>
                        <span class="detail-value">
                            üìç {{ booking.resource.location }}
                        </span>
                    </div>
                    {% endif %}
                </div>

                {% if booking.purpose %}
                <div class="detail-item" style="margin-bottom: var(--space-lg);">
                    <span class="detail-label">Purpose</span>
                    <span class="detail-value">{{ booking.purpose }}</span>
                </div>
                {% endif %}

                <div class="booking-actions">
                    <a href="{{ url_for('resources.detail_resource', resource_id=booking.resource_id) }}" 
                       class="btn btn-primary">
                        View Resource
                    </a>
                    
                    {% if is_admin_view and booking.status == 'pending' %}
                        <button class="btn btn-primary" 
                                onclick="approveBooking({{ booking.id }}, '{{ booking.resource.name }}', '{{ booking.user.full_name }}')"
                                style="background: #10B981;">
                            ‚úì Approve
                        </button>
                        <button class="btn btn-danger" 
                                onclick="denyBooking({{ booking.id }}, '{{ booking.user.full_name }}', '{{ booking.resource.name }}', '{{ booking.start_time.strftime('%b %d, %Y at %I:%M %p') }}')">
                            ‚úï Deny
                        </button>
                    {% elif booking.status == 'pending' or booking.status == 'confirmed' %}
                        <button class="btn btn-danger" 
                                onclick="cancelBooking({{ booking.id }}, '{{ booking.resource.name }}')">
                            Cancel Booking
                        </button>
                    {% endif %}
                </div>
            </div>
            {% endfor %}
        </div>
    {% else %}
        <div class="empty-state">
            <div class="empty-state-icon">üì≠</div>
            <h2>No Bookings Found</h2>
            <p>
                {% if current_status %}
                    No {{ current_status }} bookings at this time.
                {% else %}
                    {% if is_admin_view %}
                        There are no bookings in the system yet.
                    {% else %}
                        You haven't made any bookings yet. Browse resources to get started!
                    {% endif %}
                {% endif %}
            </p>
            {% if not is_admin_view %}
                <a href="{{ url_for('resources.list_resources') }}" class="btn btn-primary">
                    Browse Resources
                </a>
            {% endif %}
        </div>
    {% endif %}
</div>

<!-- Approve Booking Modal -->
<div id="approveModal" class="cancel-modal">
    <div class="cancel-modal-content">
        <div class="cancel-modal-header">
            <h2>Approve Booking</h2>
            <button class="cancel-modal-close" onclick="closeApproveModal()">&times;</button>
        </div>
        <div class="cancel-modal-body">
            <div class="cancel-icon" style="font-size: 64px;">‚úì</div>
            <p>Approve booking for <strong id="approveResourceName"></strong> by <strong id="approveStudentName"></strong>?</p>
            <p class="cancel-warning" style="color: #059669; font-size: 14px;">The student will be notified of the approval.</p>
        </div>
        <div class="cancel-modal-footer">
            <button class="btn btn-secondary" onclick="closeApproveModal()">Cancel</button>
            <button class="btn btn-primary" id="confirmApproveBtn" style="background: #10B981;">Approve Booking</button>
        </div>
    </div>
</div>

<!-- Cancel Booking Modal -->
<div id="cancelModal" class="cancel-modal">
    <div class="cancel-modal-content">
        <div class="cancel-modal-header">
            <h2>Cancel Booking</h2>
            <button class="cancel-modal-close" onclick="closeCancelModal()">&times;</button>
        </div>
        <div class="cancel-modal-body">
            <div class="cancel-icon">‚ö†Ô∏è</div>
            <p>Are you sure you want to cancel your booking for <strong id="cancelResourceName"></strong>?</p>
            <p class="cancel-warning">This action cannot be undone.</p>
        </div>
        <div class="cancel-modal-footer">
            <button class="btn btn-secondary" onclick="closeCancelModal()">Keep Booking</button>
            <button class="btn btn-danger" id="confirmCancelBtn">Cancel Booking</button>
        </div>
    </div>
</div>

<div id="denyModal" class="cancel-modal">
    <div class="cancel-modal-content">
        <div class="cancel-modal-header">
            <h2>Deny Booking</h2>
            <button class="cancel-modal-close" onclick="closeDenyModal()">&times;</button>
        </div>
        <div class="cancel-modal-body">
            <div style="background: #f0f4f8; padding: 1.25rem; border-radius: 8px; margin-bottom: 1.5rem; border-left: 4px solid #dc3545;">
                <div style="margin-bottom: 0.75rem;">
                    <div style="font-size: 0.85rem; color: #666; margin-bottom: 0.25rem;">BOOKING DETAILS</div>
                    <div style="font-weight: 600; color: #333; font-size: 1.1rem;" id="denyResourceName"></div>
                </div>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-top: 1rem;">
                    <div>
                        <div style="font-size: 0.75rem; color: #666; text-transform: uppercase; font-weight: 600; margin-bottom: 0.35rem;">Student</div>
                        <div style="color: #333;" id="denyUserName"></div>
                    </div>
                    <div>
                        <div style="font-size: 0.75rem; color: #666; text-transform: uppercase; font-weight: 600; margin-bottom: 0.35rem;">Scheduled</div>
                        <div style="color: #333;" id="denyDateTime"></div>
                    </div>
                </div>
            </div>
            
            <p style="margin-bottom: 1rem; font-weight: 600; color: #333;">Reason for Denial</p>
            <textarea id="denyReason" class="form-control" rows="3" placeholder="Enter reason for denying this booking..." style="width: 100%; padding: 0.75rem; border: 1px solid #ddd; border-radius: 6px; font-family: inherit;"></textarea>
        </div>
        <div class="cancel-modal-footer">
            <button class="btn btn-secondary" onclick="closeDenyModal()">Cancel</button>
            <button class="btn btn-danger" id="confirmDenyBtn">‚úï Deny Booking</button>
        </div>
    </div>
</div>

<script>
// CSRF token is defined globally in base.html on window object
// If for some reason it's not available, read from meta tag as fallback
const BOOKING_CSRF_TOKEN = window.CSRF_TOKEN || 
    document.querySelector('meta[name="csrf-token"]')?.getAttribute('content') || '';

console.log('[BOOKINGS] CSRF Token status:', BOOKING_CSRF_TOKEN ? `‚úÖ Found (${BOOKING_CSRF_TOKEN.length} chars)` : '‚ùå MISSING');

let currentBookingId = null;
let currentApprovalData = null;

function approveBooking(bookingId, resourceName, studentName) {
    currentBookingId = bookingId;
    currentApprovalData = { bookingId, resourceName, studentName };
    document.getElementById('approveResourceName').textContent = resourceName;
    document.getElementById('approveStudentName').textContent = studentName;
    document.getElementById('approveModal').style.display = 'flex';
}

function closeApproveModal() {
    document.getElementById('approveModal').style.display = 'none';
    currentBookingId = null;
    currentApprovalData = null;
}

function confirmApproveBooking() {
    if (!currentBookingId) return;

    console.log('[APPROVE] Starting approval for booking:', currentBookingId);
    console.log('[APPROVE] CSRF Token:', BOOKING_CSRF_TOKEN ? `Present (${BOOKING_CSRF_TOKEN.length} chars)` : 'MISSING!');
    
    if (!BOOKING_CSRF_TOKEN) {
        console.error('[APPROVE] ERROR: CSRF token is empty!');
        alert('Error: CSRF token not found. Please refresh the page.');
        return;
    }

    fetch(`/bookings/${currentBookingId}/confirm`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': BOOKING_CSRF_TOKEN
        },
        body: JSON.stringify({})
    })
    .then(response => {
        if (!response.ok) {
            return response.text().then(text => {
                throw new Error(`HTTP ${response.status}: ${text}`);
            });
        }
        return response.json();
    })
    .then(data => {
        if (data.success) {
            closeApproveModal();
            // Show success message
            const successMsg = document.createElement('div');
            successMsg.className = 'alert-success';
            successMsg.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: #10B981;
                color: white;
                padding: 16px 24px;
                border-radius: 8px;
                box-shadow: 0 4px 12px rgba(0,0,0,0.15);
                z-index: 2000;
                font-weight: 600;
            `;
            successMsg.textContent = 'Booking approved! Student notified.';
            document.body.appendChild(successMsg);
            
            setTimeout(() => {
                successMsg.remove();
                // Reload the current page to refresh bookings list
                location.reload();
            }, 2000);
        } else {
            alert('Error approving booking: ' + data.error);
        }
    })
    .catch(error => {
        alert('Error approving booking: ' + error.message);
        console.error('Error:', error);
    });
}

function cancelBooking(bookingId, resourceName) {
    currentBookingId = bookingId;
    document.getElementById('cancelResourceName').textContent = resourceName;
    document.getElementById('cancelModal').style.display = 'flex';
}

function closeCancelModal() {
    document.getElementById('cancelModal').style.display = 'none';
    currentBookingId = null;
}

function confirmCancelBooking() {
    if (!currentBookingId) return;

    fetch(`/bookings/${currentBookingId}/cancel`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': BOOKING_CSRF_TOKEN
        },
        body: JSON.stringify({})
    })
    .then(response => {
        if (!response.ok) {
            return response.text().then(text => {
                throw new Error(`HTTP ${response.status}: ${text}`);
            });
        }
        return response.json();
    })
    .then(data => {
        if (data.success) {
            closeCancelModal();
            // Show success message
            const successMsg = document.createElement('div');
            successMsg.className = 'alert-success';
            successMsg.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: #10B981;
                color: white;
                padding: 16px 24px;
                border-radius: 8px;
                box-shadow: 0 4px 12px rgba(0,0,0,0.15);
                z-index: 2000;
                font-weight: 600;
            `;
            successMsg.textContent = 'Booking cancelled successfully!';
            document.body.appendChild(successMsg);
            
            setTimeout(() => {
                successMsg.remove();
                window.location.reload();
            }, 2000);
        } else {
            // Show error in a nice toast instead of alert
            showErrorToast('Error cancelling booking: ' + data.error);
        }
    })
    .catch(error => {
        showErrorToast('Error cancelling booking: ' + error.message);
        console.error('Error:', error);
    });
}

function showErrorToast(message) {
    const errorMsg = document.createElement('div');
    errorMsg.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        background: #EF4444;
        color: white;
        padding: 16px 24px;
        border-radius: 8px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        z-index: 2000;
        font-weight: 600;
        max-width: 400px;
    `;
    errorMsg.textContent = message;
    document.body.appendChild(errorMsg);
    
    setTimeout(() => {
        errorMsg.remove();
    }, 4000);
}

function denyBooking(bookingId, userName, resourceName, dateTime) {
    currentBookingId = bookingId;
    
    // Populate modal with booking details
    document.getElementById('denyResourceName').textContent = resourceName;
    document.getElementById('denyUserName').textContent = userName;
    document.getElementById('denyDateTime').textContent = dateTime;
    document.getElementById('denyReason').value = '';
    
    document.getElementById('denyModal').style.display = 'flex';
}

function closeDenyModal() {
    document.getElementById('denyModal').style.display = 'none';
    currentBookingId = null;
}

function confirmDenyBooking() {
    if (!currentBookingId) return;
    
    const reason = document.getElementById('denyReason').value.trim();
    if (!reason) {
        alert('Please provide a reason for denying the booking.');
        return;
    }

    console.log('[DENY] Starting denial for booking:', currentBookingId);
    console.log('[DENY] Reason:', reason);
    console.log('[DENY] CSRF Token:', BOOKING_CSRF_TOKEN ? `Present (${BOOKING_CSRF_TOKEN.length} chars)` : 'MISSING!');
    console.log('[DENY] Target URL:', `/bookings/${currentBookingId}/cancel`);

    fetch(`/bookings/${currentBookingId}/cancel`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': BOOKING_CSRF_TOKEN
        },
        body: JSON.stringify({ 
            reason: reason
        })
    })
    .then(response => {
        console.log('[DENY] Response status:', response.status, response.statusText);
        if (!response.ok) {
            return response.text().then(text => {
                console.error('[DENY] Error response body:', text);
                throw new Error(`HTTP ${response.status}: ${text}`);
            });
        }
        return response.json();
    })
    .then(data => {
        console.log('[DENY] Success response:', data);
        if (data.success) {
            closeDenyModal();
            // Show success message
            const successMsg = document.createElement('div');
            successMsg.className = 'alert-success';
            successMsg.textContent = 'Booking denied successfully!';
            document.body.appendChild(successMsg);
            
            // Reload the current page to refresh bookings list
            setTimeout(() => {
                location.reload();
            }, 1500);
        } else {
            alert('Error denying booking: ' + (data.error || 'Unknown error'));
        }
    })
    .catch(error => {
        console.error('[DENY] Error:', error);
        alert('Error denying booking: ' + error.message);
    });
}

// Close modal when clicking outside
window.onclick = function(event) {
    const approveModal = document.getElementById('approveModal');
    const cancelModal = document.getElementById('cancelModal');
    const denyModal = document.getElementById('denyModal');
    
    if (event.target === approveModal) {
        closeApproveModal();
    }
    if (event.target === cancelModal) {
        closeCancelModal();
    }
    if (event.target === denyModal) {
        closeDenyModal();
    }
}

// Attach confirm handlers
document.addEventListener('DOMContentLoaded', function() {
    const confirmApproveBtn = document.getElementById('confirmApproveBtn');
    if (confirmApproveBtn) {
        confirmApproveBtn.onclick = confirmApproveBooking;
    }
    
    const confirmCancelBtn = document.getElementById('confirmCancelBtn');
    if (confirmCancelBtn) {
        confirmCancelBtn.onclick = confirmCancelBooking;
    }
    
    const confirmDenyBtn = document.getElementById('confirmDenyBtn');
    if (confirmDenyBtn) {
        confirmDenyBtn.onclick = confirmDenyBooking;
    }
});
</script>
{% endblock %}
